name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    env:
      SECRET_KEY: ci-local-secret-key-please-change
      DEBUG: "false"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Ruff format
        run: uv run ruff format .

      - name: Rumdl format
        run: uv run rumdl fmt .

      - name: Verify formatting
        run: git diff --exit-code

      - name: Ruff check
        run: uv run ruff check app tests static/js

      - name: Ty
        run: uv run ty check app

      - name: Pytest
        run: uv run pytest -q

      - name: Rumdl check
        run: uv run rumdl check .

      - name: Jx component check
        run: DEBUG=true PYTHONPATH=. uv run jx check app/rendering/catalog.py:catalog
